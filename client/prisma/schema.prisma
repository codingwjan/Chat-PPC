generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

enum MessageType {
  MESSAGE
  VOTING_POLL
  QUESTION
  ANSWER
}

enum VoteSide {
  LEFT
  RIGHT
}

enum AiJobStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

enum MessageReactionType {
  LIKE
  LOL
  FIRE
  BASED
  WTF
  BIG_BRAIN
}

enum UserBehaviorEventType {
  MESSAGE_CREATED
  USERNAME_CHANGED
  MESSAGE_TAGGING_COMPLETED
  MESSAGE_TAGGING_FAILED
  REACTION_GIVEN
  REACTION_RECEIVED
  POLL_CREATED
  POLL_EXTENDED
  POLL_VOTE_GIVEN
  AI_MENTION_SENT
}

model User {
  id               String            @id @default(cuid())
  clientId         String            @unique
  loginName        String?           @unique
  loginNameEncrypted String?
  loginNameLookup  String?           @unique
  passwordHash     String?
  sessionToken     String?
  sessionExpiresAt DateTime?
  username         String
  profilePicture   String
  status           String            @default("")
  isOnline         Boolean           @default(false)
  lastSeenAt       DateTime?
  ppcMemberScoreRaw Float            @default(0)
  ppcMemberLastActiveAt DateTime?
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  messages         Message[]
  pollVotes        PollVote[]
  pollChoiceVotes PollChoiceVote[]
  messageReactions MessageReaction[]
  tasteProfile     UserTasteProfile?
  behaviorEvents   UserBehaviorEvent[]
  notifications    Notification[]    @relation("NotificationTargetUser")
  actorNotifications Notification[]  @relation("NotificationActorUser")
  ownedBots        Bot[]

  @@index([isOnline])
  @@index([lastSeenAt])
  @@index([username])
  @@index([sessionToken])
}

model Bot {
  id                         String    @id @default(cuid())
  ownerUserId                String
  displayName                String
  profilePicture             String
  mentionHandle              String   @unique
  languagePreference         String   @default("all")
  instructions               String
  catchphrases               Json
  autonomousEnabled          Boolean  @default(false)
  autonomousMinIntervalMinutes Int    @default(60)
  autonomousMaxIntervalMinutes Int    @default(240)
  autonomousPrompt           String?
  autonomousNextAt           DateTime?
  deletedAt                  DateTime?
  createdAt                  DateTime @default(now())
  updatedAt                  DateTime @updatedAt
  owner                      User     @relation(fields: [ownerUserId], references: [id], onDelete: Cascade)
  messages                   Message[]
  aiJobs                     AiJob[]

  @@index([ownerUserId, createdAt])
  @@index([deletedAt, displayName])
  @@index([autonomousEnabled, autonomousNextAt])
}

model BlacklistEntry {
  id        String   @id @default(cuid())
  username  String   @unique
  createdAt DateTime @default(now())
}

model Message {
  id                   String      @id @default(cuid())
  legacyKey            String?     @unique
  type                 MessageType
  content              String
  authorId             String?
  botId                String?
  authorName           String
  authorProfilePicture String
  optionOne            String?
  optionTwo            String?
  pollLeftCount        Int         @default(0)
  pollRightCount       Int         @default(0)
  pollMultiSelect      Boolean     @default(false)
  pollAllowVoteChange  Boolean     @default(false)
  questionMessageId    String?
  taggingStatus        AiJobStatus?
  taggingPayload       Json?
  taggingUpdatedAt     DateTime?
  taggingError         String?
  createdAt            DateTime    @default(now())
  updatedAt            DateTime    @updatedAt
  author               User?       @relation(fields: [authorId], references: [id], onDelete: SetNull)
  bot                  Bot?        @relation(fields: [botId], references: [id], onDelete: SetNull)
  questionMessage      Message?    @relation("MessageAnswers", fields: [questionMessageId], references: [id], onDelete: SetNull)
  answers              Message[]   @relation("MessageAnswers")
  pollVotes            PollVote[]
  pollOptions          PollOption[]
  pollChoiceVotes      PollChoiceVote[]
  reactions            MessageReaction[]
  behaviorEvents       UserBehaviorEvent[]
  notifications        Notification[]
  tagJob               MessageTagJob?

  @@index([type])
  @@index([createdAt])
  @@index([botId])
  @@index([questionMessageId])
  @@index([taggingStatus, createdAt])
}

model Notification {
  id                   String              @id @default(cuid())
  userId               String
  actorUserId          String?
  actorUsernameSnapshot String
  messageId            String
  reaction             MessageReactionType
  messagePreview       String
  isRead               Boolean             @default(false)
  createdAt            DateTime            @default(now())
  readAt               DateTime?
  updatedAt            DateTime            @updatedAt
  user                 User                @relation("NotificationTargetUser", fields: [userId], references: [id], onDelete: Cascade)
  actorUser            User?               @relation("NotificationActorUser", fields: [actorUserId], references: [id], onDelete: SetNull)
  message              Message             @relation(fields: [messageId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
  @@index([userId, isRead, createdAt])
  @@index([messageId, createdAt])
}

model UserTasteProfile {
  id          String   @id @default(cuid())
  userId      String   @unique
  windowDays  Int      @default(30)
  payload     Json
  updatedAt   DateTime @updatedAt
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([updatedAt])
}

model MessageReaction {
  id        String              @id @default(cuid())
  messageId String
  userId    String
  reaction  MessageReactionType
  createdAt DateTime            @default(now())
  updatedAt DateTime            @updatedAt
  message   Message             @relation(fields: [messageId], references: [id], onDelete: Cascade)
  user      User                @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([messageId, userId])
  @@index([messageId, reaction])
  @@index([userId, updatedAt])
}

model UserBehaviorEvent {
  id            String                @id @default(cuid())
  userId        String
  type          UserBehaviorEventType
  messageId     String?
  relatedUserId String?
  reaction      MessageReactionType?
  preview       String?
  meta          Json?
  createdAt     DateTime              @default(now())
  expiresAt     DateTime
  user          User                  @relation(fields: [userId], references: [id], onDelete: Cascade)
  message       Message?              @relation(fields: [messageId], references: [id], onDelete: SetNull)

  @@index([userId, createdAt])
  @@index([userId, type, createdAt])
  @@index([expiresAt])
}

model PollVote {
  id            String   @id @default(cuid())
  pollMessageId String
  userId        String
  side          VoteSide
  createdAt     DateTime @default(now())
  pollMessage   Message  @relation(fields: [pollMessageId], references: [id], onDelete: Cascade)
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([pollMessageId, userId])
  @@index([pollMessageId])
}

model PollOption {
  id            String           @id @default(cuid())
  pollMessageId String
  label         String
  sortOrder     Int
  createdAt     DateTime         @default(now())
  pollMessage   Message          @relation(fields: [pollMessageId], references: [id], onDelete: Cascade)
  votes         PollChoiceVote[]

  @@index([pollMessageId])
  @@unique([pollMessageId, sortOrder])
}

model PollChoiceVote {
  id            String     @id @default(cuid())
  pollMessageId String
  pollOptionId  String
  userId        String
  createdAt     DateTime   @default(now())
  pollMessage   Message    @relation(fields: [pollMessageId], references: [id], onDelete: Cascade)
  pollOption    PollOption @relation(fields: [pollOptionId], references: [id], onDelete: Cascade)
  user          User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([pollMessageId])
  @@index([pollOptionId])
  @@index([userId])
  @@unique([pollMessageId, userId, pollOptionId])
}

model AiJob {
  id              String      @id @default(cuid())
  sourceMessageId String
  targetKey       String
  provider        String?
  botId           String?
  username        String
  message         String
  imageUrls       Json
  status          AiJobStatus @default(PENDING)
  attempts        Int         @default(0)
  runAt           DateTime    @default(now())
  lockedAt        DateTime?
  completedAt     DateTime?
  failedAt        DateTime?
  lastError       String?
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  bot             Bot?        @relation(fields: [botId], references: [id], onDelete: SetNull)

  @@unique([sourceMessageId, targetKey])
  @@index([status, runAt, createdAt])
  @@index([botId, status, runAt])
}

model MessageTagJob {
  id              String      @id @default(cuid())
  sourceMessageId String      @unique
  username        String
  message         String
  imageUrls       Json
  status          AiJobStatus @default(PENDING)
  attempts        Int         @default(0)
  runAt           DateTime    @default(now())
  lockedAt        DateTime?
  completedAt     DateTime?
  failedAt        DateTime?
  lastError       String?
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  sourceMessage   Message     @relation(fields: [sourceMessageId], references: [id], onDelete: Cascade)

  @@index([status, runAt, createdAt])
}
